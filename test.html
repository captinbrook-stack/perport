<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Builder Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dark .tab-content.active {
            animation: fadeInDark 0.5s ease-out;
        }
        @keyframes fadeInDark {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animated-number {
            transition: all 0.5s ease-in-out;
        }
        /* Custom scrollbar for better styling */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #e2e8f0;
            border-radius: 10px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #2d3748;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border: 2px solid #2d3748;
        }
        /* Style for the calendar days */
        .calendar-day {
            min-height: 80px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 transition-colors duration-500 dark:bg-gray-900 dark:text-gray-200">

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white">Wealth Builder Pro</h1>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-300">
                    <svg id="moon-icon" class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                    <svg id="sun-icon" class="w-6 h-6 text-gray-600 dark:text-gray-300 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-8 border-b-2 border-gray-200 dark:border-gray-700">
            <nav class="-mb-0.5 flex space-x-4 sm:space-x-8" role="tablist" aria-label="Wealth Builder Tabs">
                <button role="tab" aria-controls="dashboard-tab" id="dashboard-tab-btn" class="py-2 px-1 sm:px-4 font-medium text-sm sm:text-base border-b-2 border-transparent hover:border-blue-500 transition-colors duration-300 focus:outline-none focus:border-blue-500 aria-selected:border-blue-500 aria-selected:text-blue-500">
                    Dashboard
                </button>
                <button role="tab" aria-controls="expense-tab" id="expense-tab-btn" class="py-2 px-1 sm:px-4 font-medium text-sm sm:text-base border-b-2 border-transparent hover:border-blue-500 transition-colors duration-300 focus:outline-none focus:border-blue-500 aria-selected:border-blue-500 aria-selected:text-blue-500">
                    Expenses
                </button>
                <button role="tab" aria-controls="investment-tab" id="investment-tab-btn" class="py-2 px-1 sm:px-4 font-medium text-sm sm:text-base border-b-2 border-transparent hover:border-blue-500 transition-colors duration-300 focus:outline-none focus:border-blue-500 aria-selected:border-blue-500 aria-selected:text-blue-500">
                    Investments
                </button>
                <button role="tab" aria-controls="calendar-tab" id="calendar-tab-btn" class="py-2 px-1 sm:px-4 font-medium text-sm sm:text-base border-b-2 border-transparent hover:border-blue-500 transition-colors duration-300 focus:outline-none focus:border-blue-500 aria-selected:border-blue-500 aria-selected:text-blue-500">
                    Calendar
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="dashboard-tab" class="tab-content active p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6">Financial Dashboard</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-blue-100 dark:bg-blue-900 p-6 rounded-xl shadow-md flex flex-col justify-between">
                    <p class="text-lg font-medium text-blue-800 dark:text-blue-200">Total Assets</p>
                    <p id="total-assets" class="text-4xl sm:text-5xl font-extrabold text-blue-900 dark:text-blue-100 animated-number mt-2">$0.00</p>
                </div>
                <div class="bg-red-100 dark:bg-red-900 p-6 rounded-xl shadow-md flex flex-col justify-between">
                    <p class="text-lg font-medium text-red-800 dark:text-red-200">Total Liabilities</p>
                    <p id="total-liabilities" class="text-4xl sm:text-5xl font-extrabold text-red-900 dark:text-red-100 animated-number mt-2">$0.00</p>
                </div>
                <div class="bg-green-100 dark:bg-green-900 p-6 rounded-xl shadow-md flex flex-col justify-between">
                    <p class="text-lg font-medium text-green-800 dark:text-green-200">Net Worth</p>
                    <p id="net-worth" class="text-4xl sm:text-5xl font-extrabold text-green-900 dark:text-green-100 animated-number mt-2">$0.00</p>
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl shadow-inner">
                <h3 class="text-xl font-bold mb-4">Add a New Transaction</h3>
                <form id="transaction-form" class="space-y-4">
                    <div>
                        <label for="transaction-type" class="block text-sm font-medium mb-1">Type</label>
                        <select id="transaction-type" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300">
                            <option value="expense">Expense</option>
                            <option value="investment">Investment</option>
                        </select>
                    </div>
                    <div>
                        <label for="transaction-date" class="block text-sm font-medium mb-1">Date</label>
                        <input type="date" id="transaction-date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300">
                    </div>
                    <div>
                        <label for="transaction-description" class="block text-sm font-medium mb-1">Description</label>
                        <input type="text" id="transaction-description" placeholder="e.g., Groceries, Stock XYZ" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300">
                    </div>
                    <div>
                        <label for="transaction-amount" class="block text-sm font-medium mb-1">Amount ($)</label>
                        <input type="number" id="transaction-amount" step="0.01" placeholder="e.g., 50.00" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300">
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" id="add-transaction-btn" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">Add Transaction</button>
                        <button type="button" id="cancel-edit-btn" class="w-full py-2 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold rounded-md transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 hidden">Cancel Edit</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="expense-tab" class="tab-content p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4">Expenses</h2>
            <div id="expense-list" class="space-y-4 custom-scrollbar overflow-y-auto max-h-[60vh]">
                <!-- Expense list will be populated here -->
            </div>
        </div>

        <div id="investment-tab" class="tab-content p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4">Investments</h2>
            <div id="investment-list" class="space-y-4 custom-scrollbar overflow-y-auto max-h-[60vh]">
                <!-- Investment list will be populated here -->
            </div>
        </div>

        <div id="calendar-tab" class="tab-content p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4">Calendar</h2>
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h3 id="calendar-month-year" class="text-xl font-bold"></h3>
                <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div class="grid grid-cols-7 gap-2 text-center text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                <!-- Calendar days will be populated here -->
            </div>

            <!-- Modal for Daily Details -->
            <div id="daily-details-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 sm:p-8 w-full max-w-md shadow-2xl transform transition-all duration-300 scale-95 opacity-0">
                    <div id="details-content" class="custom-scrollbar overflow-y-auto max-h-[80vh]">
                        <!-- Content will be populated here -->
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4">
                        <button id="add-daily-transaction-btn" class="w-full sm:w-auto py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            + Add Transaction
                        </button>
                        <button id="close-modal-btn" class="w-full sm:w-auto py-2 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold rounded-md transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase log level to debug for development
        setLogLevel('debug');

        // Global variables for Firebase configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId;

        let expenses = [];
        let investments = [];

        let currentCalendarDate = new Date();
        let selectedDate = null;

        // Helper function for currency formatting
        const formatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
        });

        const initializeFirebase = async () => {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                console.log("Firebase initialized. User ID:", userId);

                // Set up real-time listeners for data
                setupListeners();

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                // In case of error, still try to proceed with a mock user ID
                userId = crypto.randomUUID();
            }
        };

        const getCollectionPath = (type) => `/artifacts/${appId}/users/${userId}/${type}`;

        const setupListeners = () => {
            if (!db || !userId) return;

            // Expenses listener
            onSnapshot(collection(db, getCollectionPath('expenses')), (snapshot) => {
                expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateExpenseTab();
                updateWealthTab();
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }, (error) => {
                console.error("Error listening to expenses:", error);
            });

            // Investments listener
            onSnapshot(collection(db, getCollectionPath('investments')), (snapshot) => {
                investments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateInvestmentTab();
                updateWealthTab();
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }, (error) => {
                console.error("Error listening to investments:", error);
            });
        };

        const addTransaction = async (event) => {
            event.preventDefault();
            const form = event.target;
            const type = form['transaction-type'].value;
            const date = form['transaction-date'].value;
            const description = form['transaction-description'].value;
            const amount = parseFloat(form['transaction-amount'].value);
            const transactionId = form.dataset.editId;

            if (isNaN(amount) || amount <= 0) {
                console.error("Please enter a valid amount.");
                return;
            }

            const transaction = { date, description, amount, createdAt: new Date() };

            try {
                if (transactionId) {
                    const docRef = doc(db, getCollectionPath(type), transactionId);
                    await updateDoc(docRef, transaction);
                    console.log("Transaction updated with ID: ", transactionId);
                    form.removeAttribute('data-edit-id');
                    document.getElementById('add-transaction-btn').textContent = 'Add Transaction';
                    document.getElementById('cancel-edit-btn').classList.add('hidden');
                } else {
                    const docRef = await setDoc(doc(collection(db, getCollectionPath(type))), transaction);
                    console.log("Transaction written with ID: ", docRef.id);
                }
                form.reset();
            } catch (e) {
                console.error("Error adding/updating document: ", e);
            }
        };

        const deleteTransaction = async (type, id) => {
            try {
                await deleteDoc(doc(db, getCollectionPath(type), id));
                console.log("Transaction deleted successfully");
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        };

        const updateTransaction = (type, transaction) => {
            const form = document.getElementById('transaction-form');
            form['transaction-type'].value = type;
            form['transaction-date'].value = transaction.date;
            form['transaction-description'].value = transaction.description;
            form['transaction-amount'].value = transaction.amount;
            form.dataset.editId = transaction.id;
            document.getElementById('add-transaction-btn').textContent = `Update ${type === 'expense' ? 'Expense' : 'Investment'}`;
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            document.getElementById('dashboard-tab-btn').click();
        };

        const updateWealthTab = () => {
            const totalAssets = investments.reduce((sum, inv) => sum + inv.amount, 0);
            const totalLiabilities = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const netWorth = totalAssets - totalLiabilities;

            document.getElementById('total-assets').textContent = formatter.format(totalAssets);
            document.getElementById('total-liabilities').textContent = formatter.format(totalLiabilities);
            document.getElementById('net-worth').textContent = formatter.format(netWorth);
        };

        const updateExpenseTab = () => {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            const sortedExpenses = expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            if (sortedExpenses.length === 0) {
                list.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No expenses recorded yet.</p>';
            }
            sortedExpenses.forEach(exp => {
                const item = createTransactionItem('expense', exp);
                list.appendChild(item);
            });
        };

        const updateInvestmentTab = () => {
            const list = document.getElementById('investment-list');
            list.innerHTML = '';
            const sortedInvestments = investments.sort((a, b) => new Date(b.date) - new Date(a.date));
            if (sortedInvestments.length === 0) {
                list.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No investments recorded yet.</p>';
            }
            sortedInvestments.forEach(inv => {
                const item = createTransactionItem('investment', inv);
                list.appendChild(item);
            });
        };

        const createTransactionItem = (type, transaction) => {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300';
            const colorClass = type === 'expense' ? 'text-red-500' : 'text-green-500';
            item.innerHTML = `
                <div>
                    <p class="font-bold text-lg">${transaction.description}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${new Date(transaction.date).toDateString()}</p>
                </div>
                <div class="flex items-center space-x-4">
                    <p class="font-semibold ${colorClass}">${formatter.format(transaction.amount)}</p>
                    <button class="edit-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </button>
                    <button class="delete-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200">
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
            item.querySelector('.edit-btn').addEventListener('click', () => updateTransaction(type, transaction));
            item.querySelector('.delete-btn').addEventListener('click', () => deleteTransaction(type, transaction.id));
            return item;
        };

        const renderCalendar = (year, month) => {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearText = document.getElementById('calendar-month-year');
            calendarGrid.innerHTML = '';
            const date = new Date(year, month);
            monthYearText.textContent = `${date.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Add empty divs for preceding days
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendarGrid.appendChild(emptyDay);
            }

            // Add actual days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(year, month, day);
                const dayString = dayDate.toISOString().split('T')[0];

                const dailyExpenses = expenses.filter(exp => exp.date === dayString);
                const dailyInvestments = investments.filter(inv => inv.date === dayString);

                const hasData = dailyExpenses.length > 0 || dailyInvestments.length > 0;
                const isToday = dayString === new Date().toISOString().split('T')[0];

                const dayElement = document.createElement('div');
                dayElement.className = `calendar-day relative p-2 rounded-lg text-center cursor-pointer transition-colors duration-300 border-2 border-transparent hover:bg-gray-200 dark:hover:bg-gray-700 ${isToday ? 'border-blue-500 bg-blue-100 dark:bg-blue-900' : 'bg-gray-50 dark:bg-gray-800'}`;
                dayElement.dataset.date = dayString;

                dayElement.innerHTML = `
                    <span class="font-bold text-lg">${day}</span>
                    <div class="mt-1 flex justify-center space-x-1">
                        ${dailyExpenses.length > 0 ? '<span class="w-2 h-2 rounded-full bg-red-500" title="Expenses"></span>' : ''}
                        ${dailyInvestments.length > 0 ? '<span class="w-2 h-2 rounded-full bg-green-500" title="Investments"></span>' : ''}
                    </div>
                `;

                dayElement.addEventListener('click', () => showDailyDetails(dayDate));
                calendarGrid.appendChild(dayElement);
            }
        };

        const showDailyDetails = (date) => {
            selectedDate = date;
            const modal = document.getElementById('daily-details-modal');
            const content = document.getElementById('details-content');
            const dateString = date.toISOString().split('T')[0];
            
            const dailyExpenses = expenses.filter(exp => exp.date === dateString);
            const dailyInvestments = investments.filter(inv => inv.date === dateString);
            
            let expensesHtml = dailyExpenses.length > 0 ?
                dailyExpenses.map(exp => `<div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700"><span>${exp.description}</span><span class="font-semibold text-red-500">${formatter.format(exp.amount)}</span></div>`).join('') :
                '<p class="text-gray-500 dark:text-gray-400">No expenses on this day.</p>';
                
            let investmentsHtml = dailyInvestments.length > 0 ?
                dailyInvestments.map(inv => `<div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700"><span>${inv.description}</span><span class="font-semibold text-green-500">${formatter.format(inv.amount)}</span></div>`).join('') :
                '<p class="text-gray-500 dark:text-gray-400">No investments on this day.</p>';

            content.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">${dateString}</h3>
                <h4 class="font-bold text-lg text-red-500">Expenses</h4>
                <div class="mb-4">${expensesHtml}</div>
                <h4 class="font-bold text-lg text-green-500">Investments</h4>
                <div>${investmentsHtml}</div>
            `;
            
            modal.querySelector('.scale-95').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('.scale-95').classList.add('scale-100', 'opacity-100');
            modal.classList.remove('hidden');
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // Initial Firebase setup
            await initializeFirebase();
            
            // DOM Elements
            const tabs = document.querySelectorAll('[role="tab"]');
            const tabContents = document.querySelectorAll('.tab-content');
            const themeToggle = document.getElementById('theme-toggle');
            const moonIcon = document.getElementById('moon-icon');
            const sunIcon = document.getElementById('sun-icon');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const dailyDetailsModal = document.getElementById('daily-details-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const addDailyTransactionBtn = document.getElementById('add-daily-transaction-btn');
            
            const transactionForm = document.getElementById('transaction-form');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const transactionDateInput = document.getElementById('transaction-date');

            // Tab functionality
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
                    tab.setAttribute('aria-selected', 'true');
                    tabContents.forEach(c => c.classList.remove('active'));
                    const targetTabId = tab.getAttribute('aria-controls');
                    document.getElementById(targetTabId).classList.add('active');
                });
            });

            // Transaction form
            transactionForm.addEventListener('submit', addTransaction);
            cancelEditBtn.addEventListener('click', () => {
                transactionForm.reset();
                transactionForm.removeAttribute('data-edit-id');
                document.getElementById('add-transaction-btn').textContent = 'Add Transaction';
                document.getElementById('cancel-edit-btn').classList.add('hidden');
            });

            // Calendar navigation
            prevMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            });

            nextMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            });

            // Daily details modal
            closeModalBtn.addEventListener('click', () => {
                dailyDetailsModal.querySelector('.scale-100').classList.remove('scale-100', 'opacity-100');
                dailyDetailsModal.querySelector('.scale-100').classList.add('scale-95', 'opacity-0');
                dailyDetailsModal.classList.add('hidden');
            });
            
            addDailyTransactionBtn.addEventListener('click', () => {
                if (selectedDate) {
                    transactionDateInput.value = selectedDate.toISOString().split('T')[0];
                }
                dailyDetailsModal.classList.add('hidden');
                document.getElementById('dashboard-tab-btn').click();
            });

            // Dark Mode
            const updateTheme = (isDark) => {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    moonIcon.classList.add('hidden');
                    sunIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    moonIcon.classList.remove('hidden');
                    sunIcon.classList.add('hidden');
                }
            };
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDark);
                updateTheme(isDark);
            });

            // Initial load
            const isDark = localStorage.getItem('darkMode') === 'true' || window.matchMedia('(prefers-color-scheme: dark)').matches;
            updateTheme(isDark);
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        });
    </script>
</body>
</html>